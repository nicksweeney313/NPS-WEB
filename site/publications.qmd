---
title: "Articles"
format:
  html:
    toc: false
---

<div id="pubs"></div>

<script>
(async function () {
  const container = document.getElementById("pubs");
  const url = "./publications.json";

  function escapeText(s) { return String(s ?? ""); }

  function normDate(d) {
    const x = String(d ?? "").trim();
    return x.length ? x : "0000-00-00";
  }

  function fmtDate(d) {
    const x = String(d ?? "").trim();
    if (!x) return "";
    const dt = new Date(x);
    if (isNaN(dt.getTime())) return x;
    return dt.toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" });
  }

  function compare(a, b, key, dir) {
    let av = a[key] ?? "";
    let bv = b[key] ?? "";
    if (key === "date") {
      av = normDate(av);
      bv = normDate(bv);
    } else {
      av = String(av).toLowerCase();
      bv = String(bv).toLowerCase();
    }
    const cmp = av < bv ? -1 : av > bv ? 1 : 0;
    return dir === "asc" ? cmp : -cmp;
  }

  // Search across all columns (including DOI URL)
  function matchesQuery(p, q) {
    if (!q) return true;
    const hay = [
      p.date, p.title, p.authors, p.journal, p.keywords, p.note, p.doi_url
    ].join(" ").toLowerCase();
    return hay.includes(q);
  }

  try {
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(`Could not load ${url} (${res.status})`);
    const data = await res.json();

    const pubsAll = (data || []).map(d => {
      const kws = Array.isArray(d.keywords) ? d.keywords : [];
      return ({
        date: d.date || d.published || d.publication_date || "",
        title: d.title || "",
        authors: (d.authors || []).join(", "),
        journal: d.venue || d.journal || "",
        keywords: kws.join(", "),
        note: d.note || "",
        doi_url: d.doi_url || d.doi || ""
      });
    });

    if (!pubsAll.length) {
      container.textContent = "No publications found.";
      return;
    }

    let pubsView = pubsAll.slice();
    let sortState = { key: "date", dir: "desc" };
    let query = "";

    // --- UI: search bar + meta ---
    const topbar = document.createElement("div");
    topbar.className = "pubs-topbar";

    const search = document.createElement("input");
    search.className = "pubs-search";
    search.type = "search";
    search.placeholder = "Search title, authors, journal, keywords, notes…";
    search.autocomplete = "off";
    search.spellcheck = false;

    const meta = document.createElement("div");
    meta.className = "pubs-meta";
    meta.textContent = "";

    topbar.appendChild(search);
    topbar.appendChild(meta);

    // --- Table skeleton ---
    const wrap = document.createElement("div");
    wrap.className = "pubs-table-wrap";

    const table = document.createElement("table");
    table.className = "pubs-table";

    const thead = document.createElement("thead");
    const headRow = document.createElement("tr");

    function makeSortableTh(label, key) {
      const th = document.createElement("th");
      th.className = "pubs-th";
      th.tabIndex = 0;
      th.setAttribute("role", "button");
      th.dataset.key = key;
      th.textContent = label;

      const toggle = () => {
        if (sortState.key === key) {
          sortState.dir = sortState.dir === "asc" ? "desc" : "asc";
        } else {
          sortState.key = key;
          sortState.dir = key === "date" ? "desc" : "asc";
        }
        renderBody();
        renderHeadIndicators();
      };

      th.addEventListener("click", toggle);
      th.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          toggle();
        }
      });

      return th;
    }

    const thDate     = makeSortableTh("Date", "date");
    const thTitle    = makeSortableTh("Title", "title");
    const thJournal  = makeSortableTh("Journal", "journal");
    const thKeywords = makeSortableTh("Keywords", "keywords");
    const thNotes    = makeSortableTh("Notes", "note");

    const thLinks = document.createElement("th");
    thLinks.textContent = "Link";

    headRow.appendChild(thDate);
    headRow.appendChild(thTitle);
    headRow.appendChild(thJournal);
    headRow.appendChild(thKeywords);
    headRow.appendChild(thNotes);
    headRow.appendChild(thLinks);

    thead.appendChild(headRow);

    const tbody = document.createElement("tbody");

    table.appendChild(thead);
    table.appendChild(tbody);
    wrap.appendChild(table);

    container.innerHTML = "";
    container.appendChild(topbar);
    container.appendChild(wrap);

    function renderHeadIndicators() {
      const map = new Map([
        [thDate, "Date"],
        [thTitle, "Title"],
        [thJournal, "Journal"],
        [thKeywords, "Keywords"],
        [thNotes, "Notes"],
      ]);

      for (const [th, base] of map.entries()) {
        const key = th.dataset.key;
        const active = sortState.key === key;
        th.classList.toggle("is-active", active);
        th.textContent = base + (active ? (sortState.dir === "asc" ? " ▲" : " ▼") : "");
      }
    }

    function applyFilter() {
      const q = query.trim().toLowerCase();
      pubsView = pubsAll.filter(p => matchesQuery(p, q));
      meta.textContent = `${pubsView.length} item${pubsView.length === 1 ? "" : "s"}`;
    }

    function renderBody() {
      applyFilter();
      pubsView.sort((a, b) => compare(a, b, sortState.key, sortState.dir));
      tbody.innerHTML = "";

      if (!pubsView.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 6;
        td.className = "pubs-empty";
        td.textContent = "No matches.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      for (const p of pubsView) {
        const tr = document.createElement("tr");

        const tdDate = document.createElement("td");
        tdDate.className = "pubs-date";
        tdDate.textContent = fmtDate(p.date);

        const tdTitle = document.createElement("td");
        tdTitle.className = "pubs-title";

        const tDiv = document.createElement("div");
        tDiv.className = "pubs-title-text";
        tDiv.textContent = escapeText(p.title);
        tdTitle.appendChild(tDiv);

        if (p.authors) {
          const aDiv = document.createElement("div");
          aDiv.className = "pubs-authors";
          aDiv.textContent = escapeText(p.authors);
          tdTitle.appendChild(aDiv);
        }

        const tdJournal = document.createElement("td");
        tdJournal.className = "pubs-journal";
        tdJournal.textContent = escapeText(p.journal);

        const tdKeywords = document.createElement("td");
        tdKeywords.className = "pubs-keywords";

        const kwList = String(p.keywords || "")
          .split(",")
          .map(s => s.trim())
          .filter(Boolean);

        if (kwList.length) {
          const chipWrap = document.createElement("div");
          chipWrap.className = "pubs-chips";
          for (const kw of kwList) {
            const chip = document.createElement("span");
            chip.className = "pubs-chip";
            chip.textContent = kw;
            chipWrap.appendChild(chip);
          }
          tdKeywords.appendChild(chipWrap);
        } else {
          tdKeywords.textContent = "";
        }

        const tdNotes = document.createElement("td");
        tdNotes.className = "pubs-notes";
        tdNotes.textContent = escapeText(p.note);

        const tdLinks = document.createElement("td");
        tdLinks.className = "pubs-links";
        const doi = String(p.doi_url || "").trim();
        if (doi) {
          const a = document.createElement("a");
          a.href = doi;
          a.target = "_blank";
          a.rel = "noopener";
          a.textContent = "DOI";
          tdLinks.appendChild(a);
        }

        tr.appendChild(tdDate);
        tr.appendChild(tdTitle);
        tr.appendChild(tdJournal);
        tr.appendChild(tdKeywords);
        tr.appendChild(tdNotes);
        tr.appendChild(tdLinks);
        tbody.appendChild(tr);
      }
    }

    // Wire search
    search.addEventListener("input", () => {
      query = search.value || "";
      renderBody();
      renderHeadIndicators();
    });

    // Initial render
    renderBody();
    renderHeadIndicators();

  } catch (err) {
    container.textContent = `Error: ${err.message}`;
  }
})();
</script>

<style>
/* Search bar */
.pubs-topbar{
  display: flex;
  gap: .75rem;
  align-items: center;
  justify-content: space-between;
  margin: .75rem 0 1rem;
}
.pubs-search{
  width: min(520px, 100%);
  padding: .6rem .75rem;
  border-radius: 12px;
  border: 1px solid rgba(0,0,0,.12);
  background: rgba(255,255,255,.8);
  outline: none;
}
.pubs-search:focus{
  border-color: rgba(0,0,0,.22);
}
.pubs-meta{
  opacity: .75;
  font-size: .95em;
  white-space: nowrap;
}

.pubs-table-wrap { overflow-x: auto; margin-top: .25rem; }

.pubs-table { width: 100%; border-collapse: collapse; }
.pubs-table th, .pubs-table td {
  padding: .75rem .8rem;
  vertical-align: top;
  border-bottom: 1px solid rgba(0,0,0,.08);
}
.pubs-table thead th {
  font-weight: 600;
  text-align: left;
  white-space: nowrap;
}

.pubs-th { cursor: pointer; user-select: none; }
.pubs-th.is-active { text-decoration: underline; }

.pubs-date { white-space: nowrap; width: 1%; }
.pubs-title-text { font-weight: 600; }
.pubs-authors { margin-top: .2rem; font-size: .92em; opacity: .8; }
.pubs-links a { white-space: nowrap; }

.pubs-empty{
  padding: 1rem .8rem;
  opacity: .8;
}

/* Keyword chips */
.pubs-chips{
  display: flex;
  flex-wrap: wrap;
  gap: .35rem;
}
.pubs-chip{
  display: inline-flex;
  align-items: center;
  padding: .25rem .55rem;
  border-radius: 999px;
  border: 1px solid rgba(0,0,0,.10);
  background: rgba(255,255,255,.65);
  font-size: .9em;
  line-height: 1.2;
  white-space: nowrap;
}

/* Notes */
.pubs-notes{
  white-space: nowrap;
  opacity: .85;
}
</style>
